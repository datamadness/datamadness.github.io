<h2 id="drive">drive</h2>
<p>layout: post
current: post
cover:  assets/images/time_signal_CNN/1280px-sampled_signal.png
navigation: True
title: Time signal classification using Convolutional Neural Network in TensorFlow - Part 1
date: 2019-03-25 22:00:00
tags: [Python]
class: post-template
subclass: ‘post tag-Python’
author: DATAmadness
mathjax: true
—</p>

<p>This example explores the possibility of using a Convolutional Neural Network(CNN) to classify time domain signal. The fundamental thesis of this work is that an arbitrarily long sampled time domain signal can be divided into short segments using a window function. These segments can be further converted to frequency domain data via <a href="https://en.wikipedia.org/wiki/Short-time_Fourier_transform">Short Time Fourier Transform(STFT)</a>	. This approach is well known from acoustics, but it is easily applicable on any frequency spectrum.
The goal of this work is to add an alternative tool to an ensemble of classifiers for time signal predictions. To illustrate, this specific classifier example was developed on <a href="https://www.kaggle.com/c/vsb-power-line-fault-detection/data">VSB Power Line Fault Detection dataset</a> where I aimed to combine three classifiers:</p>

<ul>
  <li>Long Short-Term Memory (LSTM) Recurent Neural Network(RNN),</li>
  <li>Gradient Boosted Decision Tree using signal statistics, and finally the</li>
  <li>Convolutional Neural Network(CNN)</li>
</ul>

<p>These three methods are based on very different principles and can complement each other with different sets of strengths and weaknesses.</p>

<h4 id="full-example-repo-on-github">Full example repo on GitHub</h4>
<p>If you want to get the files for the full example, you can get it from <a href="https://github.com/datamadness/Time-signal-classification-using-Convolutional-Neural-Network">this GitHub repo</a>. You’ll find two files:
<code class="highlighter-rouge">frequency domain TFRecord transformation.py</code><br />
<code class="highlighter-rouge">CNN_TFR_discharge_detection.py</code></p>

<h4 id="signal-processing">Signal Processing</h4>

<h4 id="the-raw-data">The Raw Data</h4>
<p>The raw dataset contains time domain measurements of a 3-phase transmission line. Each measurement contains three individual phase signals with 800 000 discrete data points covering 20ms (or one cycle at 50Hz). The following plot shows the data for a single measurement:</p>

<p><img src="/assets/images/time_signal_CNN/raw_data_visualization.png" alt="image post" /></p>

<p>Each phase can have one class:</p>

<ul>
  <li><strong>0</strong>: no fault / discharge</li>
  <li><strong>1</strong>: fault / discharge present</li>
</ul>

<p>Therefore, for the purposes of this particular classifier, we take each individual phase signal as a single independent sample. As a result, in the raw form we have 800k features per sample and a binary classification problem.</p>

<p><em>Warning: We still must split the data into train/test based on measurements. Having different phases from a single measurement in both train and test datasets would most certainly lead to information leak!</em></p>

<h4 id="data-transformation">Data Transformation</h4>
<p>Here is a summary of what we know about the raw signal data:</p>

<ul>
  <li>1D tensor with length $800e5$</li>
  <li>Measurement length of $20ms$ gives us</li>
  <li>Sampling frequency $f_s=40MHz$</li>
  <li>STFT can reliably resolve frequency domain features up to $20MHz$ as per <a href="https://en.wikipedia.org/wiki/Nyquist–Shannon_sampling_theorem">sampling theorem</a></li>
</ul>

<p>With this knowledge, we can use scipy stft to transform the 1D time domain data into a 2D tensor of frequency domain features. That being said, the overall length of the data is still going to amount to $800e5$ datapoints.
As an example, STFT with $nperseg=2000$ will return 2D array with a shape of 1000x800.
To reduce the data size, we can use block_reduce with a stride of 4 and np.max function(works just like pooling in CNN).</p>

<p>Here is the complete function to execute this two step transformation:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">signal_stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    
    <span class="n">fs</span> <span class="o">=</span> <span class="mf">40e6</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Zxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1999</span><span class="p">,</span><span class="n">boundary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="n">reducedZ</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">Zxx</span><span class="p">),</span> <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">)</span>

    <span class="n">reducedf</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">reducedt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">reducedt</span><span class="p">,</span> <span class="n">reducedf</span><span class="p">,</span> <span class="n">reducedZ</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'STFT Magnitude Reduced'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency [Hz]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Time [ms]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">reducedZ</span>
</code></pre></div></div>
<p>The following image plot shows the output spectrogram from a single 20ms signal:</p>

<p><img src="/assets/images/time_signal_CNN/spectrogram.png" alt="image post" /></p>

<p>The final dimension is 250x200 points, which is a considerable reduction with acceptable information loss. Additionally, the resulting 2D tensor is more favorable to CNN architectures that most of us are familiar with from image classification.</p>

<h4 id="upsampling-and-tfrecords-for-data-streaming">Upsampling and TFrecords for Data Streaming</h4>
<p>Since the transformed training data still requires gigabytes of memory, I save them into smaller TFRecords that will allow for smooth data streaming during CNN training in TensorFlow. This is described in more detail in <a href="https://datamadness.github.io/tensorflow_estimator_large_dataset_feed">this post</a>.</p>

<p>The following code will split the measurement ids into train/test datasets while protecting phase signals from a single measurement being split. 
Since the classes are also highly unbalanced(about 14:1), the code will also upsample the minor class using permutation operations to avoid having duplicated samples.
Note: Only train data is upsampled.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="n">pq</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">block_reduce</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="c">#%% PARAMETER SPECIFICATION</span>
<span class="n">eval_fraction</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c">#fraction of data for evaluation purposes</span>
<span class="c">#Specify location of the source and output data</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s">'G:</span><span class="se">\\</span><span class="s">powerLineData</span><span class="se">\\</span><span class="s">all</span><span class="se">\\</span><span class="s">'</span>
<span class="n">output_path_predict</span> <span class="o">=</span> <span class="s">'G:</span><span class="se">\\</span><span class="s">powerLineData</span><span class="se">\\</span><span class="s">TFR_predict_sfft</span><span class="se">\\</span><span class="s">'</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

<span class="c">#Get the metadata for the entire training dataset</span>
<span class="n">meta_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s">'metadata_test.csv'</span><span class="p">)</span>
<span class="n">measurement_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">meta_train</span><span class="p">[</span><span class="s">'id_measurement'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c">#Randomly shuffle the measurement ids</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">)</span>

<span class="c">#Split the id array into train and eval arrays</span>
<span class="n">trainIDs</span><span class="p">,</span> <span class="n">evalIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">,[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eval_fraction</span><span class="p">))])</span>

<span class="c">#Find how many disharges are in each measurement (int between 0 and 3) and create weight vector</span>
<span class="n">trainWeights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trainIDs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trainIDs</span><span class="p">):</span>
    <span class="n">trainWeights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">meta_train</span><span class="p">[</span><span class="s">'target'</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">meta_train</span><span class="p">[</span><span class="s">'id_measurement'</span><span class="p">]</span> <span class="o">==</span> <span class="n">ID</span><span class="p">])</span>
<span class="c">#%% Functions</span>

<span class="c"># Function gets data of a specific measurement based on measurement_id</span>
<span class="k">def</span> <span class="nf">get_measurement</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ID</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="n">ID</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">measurement</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s">'test.parquet'</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">ID</span><span class="p">,</span> <span class="n">measurement</span>

<span class="c"># Function to parse a single record from the orig MNIST data into dict</span>
<span class="k">def</span> <span class="nf">parser</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">signal_ID</span><span class="p">,</span> <span class="n">measurement_ID</span><span class="p">):</span>
    <span class="n">parsed_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'signal'</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">'C'</span><span class="p">),</span>  <span class="c">#Makes it 50000 float32 1D vector</span>
            <span class="s">'signal_ID'</span><span class="p">:</span> <span class="n">signal_ID</span><span class="p">,</span>
            <span class="s">'measurement_ID'</span><span class="p">:</span> <span class="n">measurement_ID</span><span class="p">,</span>
            <span class="s">'label'</span><span class="p">:</span> <span class="mi">9</span>
            <span class="p">}</span>
    <span class="k">return</span> <span class="n">parsed_data</span>

<span class="c"># Create the example object with features</span>
<span class="k">def</span> <span class="nf">get_tensor_object</span><span class="p">(</span><span class="n">single_record</span><span class="p">):</span>
    
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'signal'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">single_record</span><span class="p">[</span><span class="s">'signal'</span><span class="p">])),</span>
        <span class="s">'signal_ID'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">single_record</span><span class="p">[</span><span class="s">'signal_ID'</span><span class="p">]])),</span>
        <span class="s">'measurement_ID'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">single_record</span><span class="p">[</span><span class="s">'measurement_ID'</span><span class="p">]])),</span>
        <span class="s">'label'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">single_record</span><span class="p">[</span><span class="s">'label'</span><span class="p">]]))</span>
    <span class="p">}))</span>
    <span class="k">return</span> <span class="n">tensor</span>

<span class="c"># Execute STFT on phase signal data and reduce the resulting 2D matrix</span>
<span class="k">def</span> <span class="nf">signal_stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    
    <span class="n">fs</span> <span class="o">=</span> <span class="mf">40e6</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Zxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1999</span><span class="p">,</span><span class="n">boundary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="n">reducedZ</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">Zxx</span><span class="p">),</span> <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">)</span>

    <span class="n">reducedf</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">reducedt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">reducedt</span><span class="p">,</span> <span class="n">reducedf</span><span class="p">,</span> <span class="n">reducedZ</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'STFT Magnitude Reduced'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency [Hz]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Time [ms]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">reducedZ</span>

<span class="c">#%% Produce TFR files for Training (with upsampling and permutations)</span>

<span class="k">def</span> <span class="nf">generate_TFR</span><span class="p">(</span><span class="n">IDs</span><span class="p">,</span> <span class="n">measurements_per_file</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
  
    <span class="n">numFiles</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">/</span> <span class="n">measurements_per_file</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numFiles</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s"> Creating file # </span><span class="si">%2</span><span class="s">d'</span> <span class="o">%</span><span class="n">file_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">python_io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">output_path</span> <span class="o">+</span> <span class="s">'train_data_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.tfrecord'</span><span class="p">)</span> <span class="k">as</span> <span class="n">tfwriter</span><span class="p">:</span>
            
            <span class="n">measurements_left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">-</span> <span class="n">file_id</span> <span class="o">*</span> <span class="n">measurements_per_file</span>
            <span class="k">if</span> <span class="n">measurements_left</span> <span class="o">&lt;</span> <span class="n">measurements_per_file</span><span class="p">:</span>
                <span class="n">iterations</span> <span class="o">=</span> <span class="n">measurements_left</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterations</span> <span class="o">=</span> <span class="n">measurements_per_file</span>
      
            <span class="c"># Iterate through all measurements</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
                
                <span class="n">measurement</span> <span class="o">=</span> <span class="n">get_measurement</span><span class="p">(</span><span class="n">IDs</span><span class="p">[</span><span class="n">file_id</span> <span class="o">*</span> <span class="n">measurements_per_file</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
    
                <span class="k">def</span> <span class="nf">commit_record</span><span class="p">(</span><span class="n">measurement</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">measurement_ID</span> <span class="o">=</span> <span class="n">measurement</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">signal_ID</span> <span class="o">=</span> <span class="n">measurement</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">signal_ID</span><span class="p">)</span>
                        <span class="c">#float32 of 250*200</span>
                        <span class="n">signal_data</span> <span class="o">=</span> <span class="n">signal_stft</span><span class="p">(</span><span class="n">measurement</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">signal_ID</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                        <span class="n">parsed_data</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">signal_data</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">signal_ID</span><span class="p">),</span> <span class="n">measurement_ID</span><span class="p">)</span>
                        <span class="n">record_tensor</span> <span class="o">=</span> <span class="n">get_tensor_object</span><span class="p">(</span><span class="n">parsed_data</span><span class="p">)</span>
                        <span class="c"># Append tensor data into tfrecord file</span>
                        <span class="n">tfwriter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">record_tensor</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
                        
                <span class="n">commit_record</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>
<span class="c">#%% Execute functions</span>
<span class="c"># Train IDs: List of mesurement IDs to export into TFR files</span>
<span class="c"># Measurements_per_file: How many real measurements to save in each TFR file</span>
<span class="c"># Upscale: True / False add artificially computed reords with discharges (improving class balance)</span>
<span class="c"># Output path: folder path where to save the TFR files</span>

<span class="c">#Generate TFR records for training data with upscaling</span>
<span class="n">generate_TFR</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">,</span> <span class="n">measurements_per_file</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path_predict</span><span class="p">)</span>

</code></pre></div></div>

<p>I will focus on using the preprocessed frequency domain data in a Convolutional Neural Network in part 2 of this mini-series.</p>

<p><a href="https://datamadness.github.io/time-signal-CNN-part2">Read Part 2</a></p>
