<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Time signal classification using Convolutional Neural Network in TensorFlow - Part 1</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Exploring the world through data analysis and machine learning" />
    <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="/time-signal-CNN" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="DATAmadness" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Time signal classification using Convolutional Neural Network in TensorFlow - Part 1" />
    <meta property="og:description" content="This example explores the possibility to use Convolutional Neural Network(CNN) to classify time domain signal. The fundamental thesis of this work is that arbitrarily long sampled time domain signal can be divided into short segments using a window function. These segments can be further converted to frequency domain data via" />
    <meta property="og:url" content="/time-signal-CNN" />
    <meta property="og:image" content="/assets/images/time_signal_CNN/1280px-sampled_signal.png" />
    <meta property="article:publisher" content="https://www.facebook.com/ghost" />
    <meta property="article:author" content="https://www.facebook.com/ghost" />
    <meta property="article:published_time" content="2019-03-25T15:00:00-07:00" />
    <meta property="article:modified_time" content="2019-03-25T15:00:00-07:00" />
    <meta property="article:tag" content="Python" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Time signal classification using Convolutional Neural Network in TensorFlow - Part 1" />
    <meta name="twitter:description" content="This example explores the possibility to use Convolutional Neural Network(CNN) to classify time domain signal. The fundamental thesis of this work is that arbitrarily long sampled time domain signal can be divided into short segments using a window function. These segments can be further converted to frequency domain data via" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image" content="/assets/images/time_signal_CNN/1280px-sampled_signal.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="DATAmadness" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Python" />
    <meta name="twitter:site" content="@Mr_Bubble_Wrap" />
    <meta name="twitter:creator" content="@Mr_Bubble_Wrap" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "DATAmadness",
        "logo": "/assets/images/blog-icon.png"
    },
    "url": "/time-signal-CNN",
    "image": {
        "@type": "ImageObject",
        "url": "/assets/images/time_signal_CNN/1280px-sampled_signal.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/time-signal-CNN"
    },
    "description": "This example explores the possibility to use Convolutional Neural Network(CNN) to classify time domain signal. The fundamental thesis of this work is that arbitrarily long sampled time domain signal can be divided into short segments using a window function. These segments can be further converted to frequency domain data via"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Time signal classification using Convolutional Neural Network in TensorFlow - Part 1" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="/"><img src="/assets/images/blog-icon.png" alt="DATAmadness" /></a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-Statistics" role="menuitem"><a href="/tag/statistics/">Statistics</a></li>
    <li class="nav-Python" role="menuitem"><a href="/tag/python/">Python</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-fb" href="https://facebook.com/ghost" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
</a>
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/Mr_Bubble_Wrap" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

		
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
>
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://vincenttam.github.io/javascripts/MathJaxLocal.js"
>
</script>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-Python ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="25 March 2019">25 March 2019</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/python/'>PYTHON</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Time signal classification using Convolutional Neural Network in TensorFlow - Part 1</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/time_signal_CNN/1280px-sampled_signal.png)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>This example explores the possibility to use Convolutional Neural Network(CNN) to classify time domain signal. The fundamental thesis of this work is that arbitrarily long sampled time domain signal can be divided into short segments using a window function. These segments can be further converted to frequency domain data via <a href="https://en.wikipedia.org/wiki/Short-time_Fourier_transform">Short Time Fourier Transform(STFT)</a>	. This approach is well known from acoustics, but it is easily applicable on any frequency spectrum.
The goal of this work is to add an alternative tool to ensemble of classifiers for time signal predictions. As an example, this specific classifier example was developed on <a href="https://www.kaggle.com/c/vsb-power-line-fault-detection/data">VSB Power Line Fault Detection dataset</a> where I aimed to combine three classifiers:</p>

<ul>
  <li>Long Short-Term Memory (LSTM) Recurent Neural Network(RNN),</li>
  <li>Gradient Boosted Decision Tree using signal statistics, and finally the</li>
  <li>Convolutional Neural Network(CNN)</li>
</ul>

<p>These three methods are based on very different principles and therefore, they can complement each other with different sets of strengths and weaknesses.</p>

<h4 id="full-example-repo-on-github">Full example repo on GitHub</h4>
<p>If you want to get the files for the full example, you can get it from <a href="https://github.com/datamadness/Time-signal-classification-using-Convolutional-Neural-Network">this GitHub repo</a>. You’ll find two files:
<code class="highlighter-rouge">frequency domain TFRecord transformation.py</code><br />
<code class="highlighter-rouge">CNN_TFR_discharge_detection.py</code></p>

<h4 id="signal-processing">Signal Processing</h4>
<h5 id="the-raw-data">The Raw Data</h5>
<p>The raw dataset contains time domain measurements of 3 phase transmission line. Each measurement contains three individual phase signals with 800 000 discrete data points covering 20ms (or one cycle at 50Hz). The following plot shows the data for single measurement:
<img src="/assets/images/time_signal_CNN/raw_data_visualization.png" alt="image post" /></p>

<p>Each phase can have one class:</p>

<ul>
  <li><strong>0</strong>: no fault / discharge</li>
  <li><strong>1</strong>: fault / discharge present</li>
</ul>

<p>Therefore, for the purposes of this particular classifier, we take each individual phase signal as a single independent sample. As a result, in the raw form we have 800k features per sample and a binary classification problem.</p>

<p><em>Warning: We still must split the data into train/test based on measurements. Having different phases from a single measurement in both train and test dataset would most certainly lead to information leak!</em></p>

<h5 id="data-transformation">Data Transformation</h5>
<p>Here is a summary what we know about the raw signal data:</p>

<ul>
  <li>1D tensor with length $800e5$</li>
  <li>Measurement length of $20ms$ gives us</li>
  <li>Sampling frequency $f_s=40MHz$</li>
  <li>STFT can reliably resolve frequency domain features up to $20MHz$ as per <a href="https://en.wikipedia.org/wiki/Nyquist–Shannon_sampling_theorem">sampling theorem</a></li>
</ul>

<p>With this knowledge, we can use scipy stft to transform the 1D time domain data into 2D tensor of frequency domain features. That being said, the overall length of the data is still going to amount to $800e5$ datapoints.
As an example STFT with $nperseg=2000$ will return 2D array with shape 1000x800.
To reduce the data size, we can use block_reduce with stride of 4 and np.max function(works just like pooling in CNN).</p>

<p>Here is the complete function to execute this two step transformation:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">signal_stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    
    <span class="n">fs</span> <span class="o">=</span> <span class="mf">40e6</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Zxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1999</span><span class="p">,</span><span class="n">boundary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="n">reducedZ</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">Zxx</span><span class="p">),</span> <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">)</span>

    <span class="n">reducedf</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">reducedt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">reducedt</span><span class="p">,</span> <span class="n">reducedf</span><span class="p">,</span> <span class="n">reducedZ</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'STFT Magnitude Reduced'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency [Hz]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Time [ms]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">reducedZ</span>
</code></pre></div></div>
<p>The following image plot shows the output spectrogram from a single 20ms signal:
<img src="/assets/images/time_signal_CNN/spectrogram.png" alt="image post" />
The final dimension is 250x200 points, which is considerable reduction with acceptable information loss. Additionally, the resulting 2D tensor is more favorable to CNN architectures that most of us are familiar with from image classification.</p>

<h5 id="upsampling-and-tfrecords-for-data-streaming">Upsampling and TFrecords for Data Streaming</h5>
<p>Since the transformed training data still require gigabytes of memory, I save them into smaller TFRecords that will allow smooth data streaming during CNN training in TensorFlow. This is described in more detail in <a href="https://datamadness.github.io/tensorflow_estimator_large_dataset_feed">this post</a>.</p>

<p>The following code will split the measurement ids into train/test datasets while protecting phase signals from single measurement being split. 
Since the classes are also highly unbalanced(about 14:1), the code will also upsample the minor class using permutation operations to avoid having duplicated samples.
Note: Only train data are upsampled.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="n">pq</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">block_reduce</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="c">#%% PARAMETER SPECIFICATION</span>
<span class="n">eval_fraction</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c">#fraction of data for evaluation purposes</span>
<span class="c">#Specify location of the source and output data</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s">'G:</span><span class="se">\\</span><span class="s">powerLineData</span><span class="se">\\</span><span class="s">all</span><span class="se">\\</span><span class="s">'</span>
<span class="n">output_path_predict</span> <span class="o">=</span> <span class="s">'G:</span><span class="se">\\</span><span class="s">powerLineData</span><span class="se">\\</span><span class="s">TFR_predict_sfft</span><span class="se">\\</span><span class="s">'</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

<span class="c">#Get the metadata for the entire training dataset</span>
<span class="n">meta_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s">'metadata_test.csv'</span><span class="p">)</span>
<span class="n">measurement_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">meta_train</span><span class="p">[</span><span class="s">'id_measurement'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c">#Randomly shuffle the measurement ids</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">)</span>

<span class="c">#Split the id array into train and eval arrays</span>
<span class="n">trainIDs</span><span class="p">,</span> <span class="n">evalIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">,[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eval_fraction</span><span class="p">))])</span>

<span class="c">#Find how many disharges are in each measurement (int between 0 and 3) and create weight vector</span>
<span class="n">trainWeights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trainIDs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trainIDs</span><span class="p">):</span>
    <span class="n">trainWeights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">meta_train</span><span class="p">[</span><span class="s">'target'</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">meta_train</span><span class="p">[</span><span class="s">'id_measurement'</span><span class="p">]</span> <span class="o">==</span> <span class="n">ID</span><span class="p">])</span>
<span class="c">#%% Functions</span>

<span class="c"># Function gets data of a specific measurement based on measurement_id</span>
<span class="k">def</span> <span class="nf">get_measurement</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ID</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="n">ID</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">measurement</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s">'test.parquet'</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">ID</span><span class="p">,</span> <span class="n">measurement</span>

<span class="c"># Function to parse a single record from the orig MNIST data into dict</span>
<span class="k">def</span> <span class="nf">parser</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">signal_ID</span><span class="p">,</span> <span class="n">measurement_ID</span><span class="p">):</span>
    <span class="n">parsed_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'signal'</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s">'C'</span><span class="p">),</span>  <span class="c">#Makes it 50000 float32 1D vector</span>
            <span class="s">'signal_ID'</span><span class="p">:</span> <span class="n">signal_ID</span><span class="p">,</span>
            <span class="s">'measurement_ID'</span><span class="p">:</span> <span class="n">measurement_ID</span><span class="p">,</span>
            <span class="s">'label'</span><span class="p">:</span> <span class="mi">9</span>
            <span class="p">}</span>
    <span class="k">return</span> <span class="n">parsed_data</span>

<span class="c"># Create the example object with features</span>
<span class="k">def</span> <span class="nf">get_tensor_object</span><span class="p">(</span><span class="n">single_record</span><span class="p">):</span>
    
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'signal'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">single_record</span><span class="p">[</span><span class="s">'signal'</span><span class="p">])),</span>
        <span class="s">'signal_ID'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">single_record</span><span class="p">[</span><span class="s">'signal_ID'</span><span class="p">]])),</span>
        <span class="s">'measurement_ID'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">single_record</span><span class="p">[</span><span class="s">'measurement_ID'</span><span class="p">]])),</span>
        <span class="s">'label'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">single_record</span><span class="p">[</span><span class="s">'label'</span><span class="p">]]))</span>
    <span class="p">}))</span>
    <span class="k">return</span> <span class="n">tensor</span>

<span class="c"># Execute STFT on phase signal data and reduce the resulting 2D matrix</span>
<span class="k">def</span> <span class="nf">signal_stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    
    <span class="n">fs</span> <span class="o">=</span> <span class="mf">40e6</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Zxx</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">phase_data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="mi">1999</span><span class="p">,</span><span class="n">boundary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="n">reducedZ</span> <span class="o">=</span> <span class="n">block_reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">Zxx</span><span class="p">),</span> <span class="n">block_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">)</span>

    <span class="n">reducedf</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">reducedt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">reducedt</span><span class="p">,</span> <span class="n">reducedf</span><span class="p">,</span> <span class="n">reducedZ</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'STFT Magnitude Reduced'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency [Hz]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Time [ms]'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">reducedZ</span>

<span class="c">#%% Produce TFR files for Training (with upsampling and permutations)</span>

<span class="k">def</span> <span class="nf">generate_TFR</span><span class="p">(</span><span class="n">IDs</span><span class="p">,</span> <span class="n">measurements_per_file</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
  
    <span class="n">numFiles</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">/</span> <span class="n">measurements_per_file</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numFiles</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s"> Creating file # </span><span class="si">%2</span><span class="s">d'</span> <span class="o">%</span><span class="n">file_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">python_io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">output_path</span> <span class="o">+</span> <span class="s">'train_data_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.tfrecord'</span><span class="p">)</span> <span class="k">as</span> <span class="n">tfwriter</span><span class="p">:</span>
            
            <span class="n">measurements_left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">-</span> <span class="n">file_id</span> <span class="o">*</span> <span class="n">measurements_per_file</span>
            <span class="k">if</span> <span class="n">measurements_left</span> <span class="o">&lt;</span> <span class="n">measurements_per_file</span><span class="p">:</span>
                <span class="n">iterations</span> <span class="o">=</span> <span class="n">measurements_left</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterations</span> <span class="o">=</span> <span class="n">measurements_per_file</span>
      
            <span class="c"># Iterate through all measurements</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
                
                <span class="n">measurement</span> <span class="o">=</span> <span class="n">get_measurement</span><span class="p">(</span><span class="n">IDs</span><span class="p">[</span><span class="n">file_id</span> <span class="o">*</span> <span class="n">measurements_per_file</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
    
                <span class="k">def</span> <span class="nf">commit_record</span><span class="p">(</span><span class="n">measurement</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">measurement_ID</span> <span class="o">=</span> <span class="n">measurement</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">signal_ID</span> <span class="o">=</span> <span class="n">measurement</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">signal_ID</span><span class="p">)</span>
                        <span class="c">#float32 of 250*200</span>
                        <span class="n">signal_data</span> <span class="o">=</span> <span class="n">signal_stft</span><span class="p">(</span><span class="n">measurement</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">signal_ID</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                        <span class="n">parsed_data</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">signal_data</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">signal_ID</span><span class="p">),</span> <span class="n">measurement_ID</span><span class="p">)</span>
                        <span class="n">record_tensor</span> <span class="o">=</span> <span class="n">get_tensor_object</span><span class="p">(</span><span class="n">parsed_data</span><span class="p">)</span>
                        <span class="c"># Append tensor data into tfrecord file</span>
                        <span class="n">tfwriter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">record_tensor</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
                        
                <span class="n">commit_record</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span>
<span class="c">#%% Execute functions</span>
<span class="c"># Train IDs: List of mesurement IDs to export into TFR files</span>
<span class="c"># Measurements_per_file: How many real measurements to save in each TFR file</span>
<span class="c"># Upscale: True / False add artificially computed reords with discharges (improving class balance)</span>
<span class="c"># Output path: folder path where to save the TFR files</span>

<span class="c">#Generate TFR records for training data with upscaling</span>
<span class="n">generate_TFR</span><span class="p">(</span><span class="n">measurement_id</span><span class="p">,</span> <span class="n">measurements_per_file</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path_predict</span><span class="p">)</span>

</code></pre></div></div>

<p>I will focus on using the preprocessed frequency domain data in a Convolutional Neural Network in part 2 of this mini-series.</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/DM_favicon.png" alt="DATAmadness" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/DATAmadness">DATAmadness</a></h4>
                                
                                    <p>An American pastor, activist, humanitarian. People know me for leading the African-American Civil Rights movement using nonviolent civil disobedience.</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/DATAmadness">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.png)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; DATAmadness &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/python/">Python</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/tensorflow_input_funtion_tip">TensorFlow Tip - input_fn with custom parameters</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/tensorflow_estimator_large_dataset_feed">TensorFlow Estimators API - Feeding large datasets from drive via TFRecords (MNIST example)</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/Skewness_Auto_Transform">Python function to automatically transform skewed data in Pandas DataFrame</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/python/">
                                
                                    See all 4 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/tensorflow_input_funtion_tip">
                <div class="post-card-image" style="background-image: url(/assets/images/input_function/Fort_Gibson_dam_2.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/tensorflow_input_funtion_tip">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Python</span>
                            
                        
                    

                    <h2 class="post-card-title">TensorFlow Tip - input_fn with custom parameters</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>TensorFlow Estimators API is great for quickly building your custom models, but you might have noticed there is no obvious way to pass custom parameters into the input_fn from your estimator. That can</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/DM_favicon.png" alt="DATAmadness" />
                        
                        <span class="post-card-author">
                            <a href="/author/DATAmadness/">DATAmadness</a>
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="/">
            
                <img src="/assets/images/favicon.png" alt="DATAmadness icon" />
            
            <span>DATAmadness</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Time signal classification using Convolutional Neural Network in TensorFlow - Part 1</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Time+signal+classification+using+Convolutional+Neural+Network+in+TensorFlow+-+Part+1&amp;url=https://datamadness.github.io/time-signal-CNN"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://datamadness.github.io/time-signal-CNN"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="/">DATAmadness</a> &copy; 2019</section>
                <section class="poweredby">Published with Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    <a href="https://facebook.com/ghost" target="_blank" rel="noopener">Facebook</a>
                    <a href="https://twitter.com/Mr_Bubble_Wrap" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://www.nasa.gov/multimedia/nasatv#public" target="_blank" rel="noopener">Watch live stream from ISS to relax</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-121059326-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
